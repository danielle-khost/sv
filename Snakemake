import yaml
import glob, os, pathlib


#Config file
configfile: "config/config.yaml"
samsheet="config/samples.tsv"

samdict = {}
with open(samsheet) as fin:
    for line in fin:
        data = line.split("\t")
        samdict[data[0]] = {'bamfile' : data[1]}

samples = list(samdict.keys())

#Global variables from config
ref_org = config["ref_org"]
surv_path = config["survivor_path"]
callers = ["sniffles", "cutesv", "svim"]

#Functions
def get_bam(wildcards):
    bfile = samdict[wildcards.sample]['bamfile']
    return bfile


#Global rule
rule all:
    input:
        expand(" ", sample=samples)


#Rules
rule snifflesCall:
    input:
        ref = config["reference"]
        bamfile = get_bam
    output:
        vcf = "{sample}_vs_" + ref_org + "_sniffles.vcf"
        snf = "{sample}_vs_ + ref_org + "_sniffles.snf"
    conda:
        "workflow/envs/sniffles.yaml"
    shell:
        "sniffles --threads 8 --reference {input.ref} --input {input.bamfile} --vcf {output.vcf} --snf {output.snf}"

rule cutesvCall:
    input:
        ref = config["reference"]
        bamfile = get_bam
    output:
        vcf = "{sample}_vs_" + ref_org + "_cutesv.vcf"
    conda:
        "workflow/envs/cutesv.yaml"
    shell:
        "cuteSV --max_cluster_bias_INS 100 --diff_ratio_merging_INS 0.3 --max_cluster_bias_DEL 100 --diff_ratio_merging_DE 0.3 {input.bamfile} {output.vcf}"

rule svimCall:
    input:
        ref = config["reference"]
        bamfile = get_bam
    output:
        vcf = "{sample}_vs_" + ref_org + "_svim.vcf"
    conda:
        "workflow/envs/svim.yaml"
    shell:
        "svim alignment "

rule vcfMerge:
    input:
        snif = "{sample}_vs_" + ref_org + "_sniffles.vcf"
        cute = "{sample}_vs_" + ref_org + "_cutesv.vcf"
        svim = "{sample}_vs_" + ref_org + "_svim.vcf"
    output:
        "{sample}_merged.vcf"
    params:
        surv_path = config["survivor_path"]
    shell:
        """
        ls {input.snif} {input.cute} {input.svim} > {sample}_vcfs.txt
        {params.surv_path}/SURVIVOR merge {sample}_vcfs.txt 1000 3 1 1 0 50 {output}
        """

rule vcfFilter:
    input:
        "{sample}_merged.vcf"
    output:
        filt = "{sample}_merged_filtered_nogaps.vcf"
    params:
        gaps = config["gap_bed"]
    params:
        surv_path = config["survivor_path"]
    shell:
        """
        grep -v '<TRA>' {input} | bcftools view -i 'SVLEN>49 && SVLEN<100000 && SUPPORT<60' - > {sample}_merged_filtered.vcf
        {params.surv_path}/SURVIVOR filter {sample}_merged_filtered.vcf {params.gaps} 50 -1 0 -1 {output.filt}
        """

rule forceCall:
    input:
        ref = config["reference"]
        bamfile = get_bam
        knownsv = "{sample}_merged_filtered_nogaps.vcf"
    output:
        "{sample}_finalCall.vcf"
    conda:
        "workflow/envs/sniffles.yaml"
    shell:
        "sniffles --input {input.bamfile} --reference {input.ref} {input.knownsv} --vcf {output}"