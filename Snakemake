import yaml
import glob, os, pathlib


#Config file
configfile: "config/config.yaml"
res_config: "config/resources.yaml"
samsheet="config/samples.tsv"

samdict = {}
with open(samsheet) as fin:
    for line in fin:
        data = line.split("\t")
        samdict[data[0]] = {'bamfile' : data[1]}

samples = list(samdict.keys())

#Global variables from config
ref_org = config["ref_org"]
int_files = config["intermediate_files"]

#Functions
def get_bam(wildcards):
    bfile = samdict[wildcards.sample]['bamfile']
    return bfile


#Global rule
rule all:
    input:
        expand("results/{sample}_finalCall.vcf", sample=samples)


#Rules
rule snifflesCall:
    input:
        ref = config["reference"],
        bamfile = get_bam
    output:
        vcf = int_files + "{sample}_vs_" + ref_org + "_sniffles.vcf",
        snf = int_files +  "{sample}_vs_" + ref_org + "_sniffles.snf"
    conda:
        "workflow/envs/sniffles.yaml"
    resources:
        mem_mb = lambda wildcards, attempt: attempt * 1.5 * res_config["sniffles_call"]["mem_mb"],
        time = res_config["sniffles_call"]["time"]
    threads:
        res_config['sniffles_call']['threads']
    shell:
        "sniffles --threads {threads} --reference {input.ref} --input {input.bamfile} --vcf {output.vcf} --snf {output.snf}"

rule cutesvCall:
    input:
        ref = config["reference"],
        bamfile = get_bam
    output:
        vcf = int_files + "{sample}_vs_" + ref_org + "_cutesv.vcf"
    conda:
        "workflow/envs/cutesv.yaml"
    resources:
        mem_mb = lambda wildcards, attempt: attempt * 1.5 * res_config["cutesv_call"]["mem_mb"],
        time = res_config["cutesv_call"]["time"]
    threads:
        res_config['cutesv_call']['threads']
    shell:
        "cuteSV -t {threads} --max_cluster_bias_INS 100 --diff_ratio_merging_INS 0.3 --max_cluster_bias_DEL 100 --diff_ratio_merging_DE 0.3 {input.bamfile} {output.vcf}"

rule svimCall:
    input:
        ref = config["reference"],
        bamfile = get_bam
    output:
        vcf = int_files + "{sample}_vs_" + ref_org + "_svim.vcf"
    conda:
        "workflow/envs/svim.yaml"
    resources:
        mem_mb = lambda wildcards, attempt: attempt * 1.5 * res_config["svim_call"]["mem_mb"],
        time = res_config["svim_call"]["time"]
    params:
        outdir = "workflow/{sample}_svim"
    shell:
        """
        svim alignment {params.outdir} {input.bamfile} {input.ref}
        mv {params.outdir}/variants.vcf {output.vcf}
        """

rule vcfMerge:
    input:
        snif = int_files + "{sample}_vs_" + ref_org + "_sniffles.vcf",
        cute = int_files + "{sample}_vs_" + ref_org + "_cutesv.vcf",
        svim = int_files + "{sample}_vs_" + ref_org + "_svim.vcf"
    output:
        "{sample}_merged.vcf"
    resources:
        mem_mb = lambda wildcards, attempt: attempt * 1.5 * res_config["vcf_merge"]["mem_mb"],
        time = res_config["vcf_merge"]["time"]
    params:
        surv_path = config["survivor_path"]
    shell:
        """
        ls {input.snif} {input.cute} {input.svim} > {sample}_vcfs.txt
        {params.surv_path} merge {sample}_vcfs.txt 1000 3 1 1 0 50 {output}
        """

rule vcfFilter:
    input:
        "{sample}_merged.vcf"
    output:
        filt = "{sample}_merged_filtered_nogaps.vcf"
    resources:
        mem_mb = lambda wildcards, attempt: attempt * 1.5 * res_config["vcf_filter"]["mem_mb"],
        time = res_config["vcf_filter"]["time"]
    params:
        gaps = config["gap_bed"],
        surv_path = config["survivor_path"]
    conda:
        "workflow/envs/bcftools.yaml"
    shell:
        """
        grep -v '<TRA>' {input} | bcftools view -i 'QUAL >= 10 && SVLEN>=50 && SVLEN<100000 && SUPPORT<60' - > {sample}_merged_filtered.vcf
        {params.surv_path} filter {sample}_merged_filtered.vcf {params.gaps} 50 -1 0 -1 {output.filt}
        """

rule forceCall:
    input:
        ref = config["reference"],
        bamfile = get_bam,
        knownsv = "{sample}_merged_filtered_nogaps.vcf"
    output:
        "results/{sample}_finalCall.vcf"
    resources:
        mem_mb = lambda wildcards, attempt: attempt * 1.5 * res_config["force_call"]["mem_mb"],
        time = res_config["force_call"]["time"]
    threads:
        res_config['force_call']['threads']
    conda:
        "workflow/envs/sniffles.yaml"
    shell:
        "sniffles --threads {threads} --input {input.bamfile} --reference {input.ref} {input.knownsv} --vcf {output}"